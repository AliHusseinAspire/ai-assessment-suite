generator client {
  provider = "prisma-client-js"
  output   = "./generated/client"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum EventRole {
  OWNER
  MEMBER
  GUEST
}

enum EventStatus {
  UPCOMING
  ONGOING
  PAST
  CANCELLED
}

enum RsvpStatus {
  ATTENDING
  MAYBE
  DECLINED
  PENDING
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  DECLINED
  MAYBE
  CANCELLED
}

model User {
  id         String       @id @default(cuid())
  email      String       @unique
  name       String
  role       EventRole    @default(GUEST)
  supabaseId String       @unique @map("supabase_id")
  createdAt  DateTime     @default(now()) @map("created_at")
  updatedAt  DateTime     @updatedAt @map("updated_at")

  ownedEvents    Event[]          @relation("EventOwner")
  rsvps          Rsvp[]
  sentInvites    Invitation[]     @relation("InvitationSender")
  receivedInvites Invitation[]    @relation("InvitationRecipient")
  activities     Activity[]

  @@map("users")
}

model Event {
  id           String      @id @default(cuid())
  title        String
  description  String?
  location     String?
  startDate    DateTime    @map("start_date")
  endDate      DateTime    @map("end_date")
  allDay       Boolean     @default(false) @map("all_day")
  status       EventStatus @default(UPCOMING)
  isRecurring  Boolean     @default(false) @map("is_recurring")
  recurrence   Json?
  color        String      @default("#0d9488")
  maxAttendees Int?        @map("max_attendees")
  ownerId      String      @map("owner_id")
  owner        User        @relation("EventOwner", fields: [ownerId], references: [id])
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")

  rsvps       Rsvp[]
  invitations Invitation[]
  activities  Activity[]

  @@index([ownerId])
  @@index([status])
  @@index([startDate])
  @@index([endDate])
  @@map("events")
}

model Rsvp {
  id        String     @id @default(cuid())
  status    RsvpStatus @default(PENDING)
  note      String?
  userId    String     @map("user_id")
  user      User       @relation(fields: [userId], references: [id])
  eventId   String     @map("event_id")
  event     Event      @relation(fields: [eventId], references: [id], onDelete: Cascade)
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")

  @@unique([userId, eventId])
  @@index([userId])
  @@index([eventId])
  @@map("rsvps")
}

model Invitation {
  id          String           @id @default(cuid())
  status      InvitationStatus @default(PENDING)
  message     String?
  senderId    String           @map("sender_id")
  sender      User             @relation("InvitationSender", fields: [senderId], references: [id])
  recipientId String           @map("recipient_id")
  recipient   User             @relation("InvitationRecipient", fields: [recipientId], references: [id])
  eventId     String           @map("event_id")
  event       Event            @relation(fields: [eventId], references: [id], onDelete: Cascade)
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")

  @@unique([recipientId, eventId])
  @@index([senderId])
  @@index([recipientId])
  @@index([eventId])
  @@map("invitations")
}

model Activity {
  id        String    @id @default(cuid())
  action    String
  details   Json?
  userId    String    @map("user_id")
  user      User      @relation(fields: [userId], references: [id])
  eventId   String?   @map("event_id")
  event     Event?    @relation(fields: [eventId], references: [id], onDelete: SetNull)
  createdAt DateTime  @default(now()) @map("created_at")

  @@index([userId])
  @@index([eventId])
  @@index([createdAt])
  @@map("activities")
}
